<link href="https://fonts.googleapis.com/css?family=Lexend" rel="stylesheet">
<style>
  /* WSAF */
  .screensize {
    overflow: hidden;
    border: 1px solid;
    background-color: #087F8C;
    background-size: contain;

    position: relative;
  }

  .screensize, .lexend {
    font-family: 'Lexend', Arial, sans-serif;
  }

  .wsaf-events {
    position: absolute;
    overflow: hidden;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-content: start;
  }

  .wsaf-events article {
    background-color: #4F1D75;
    color: #fff;
    flex-grow: 1;
    padding: 10px;
    text-align: center;
  }

  article.colour-YELLOW, .wsaf-heading.colour-YELLOW > p {
    background-color: #FFBD00 !important;
    color: #000 !important;
  }

  article.colour-ORANGE, .wsaf-heading.colour-ORANGE > p {
    background-color: #F5722F !important;
    color: #fff !important;
  }

  article.colour-PINK, .wsaf-heading.colour-PINK > p {
    background-color: #B82458 !important;
    color: #fff !important;
  }

  .wsaf-events .time {
    font-size: 14px;
    text-transform: uppercase;
    font-weight: bolder;
    margin-bottom: 2px;
  }

  .wsaf-events img {
    object-fit: contain;
    height: 55px;
    margin-bottom: 5px;
  }

  .wsaf-events .presented-by {
    font-style: italic;
    font-size: 12px;
    line-height: 15px;
    margin: 0;
    text-overflow: ellipsis;
    overflow: hidden;
    text-wrap: nowrap;
  }

  .wsaf-events .title {
    font-weight: bolder;
    font-size: 18px;
    line-height: 22px;
    margin: 0;
    text-overflow: ellipsis;
    overflow: hidden;
    text-wrap: nowrap;
  }

  .wsaf-events .venue {
    text-transform: uppercase;
    font-size: 13px;
    margin: 0;
    font-weight: bold;
    text-overflow: ellipsis;
    overflow: hidden;
    text-wrap: nowrap;
  }

  .wsaf-heading {
    position: absolute;
    display: none;
  }

  .wsaf-heading p {
    background-color: #4F1D75;
    color: #fff;
    text-transform: uppercase;
    font-size: 35px;
    padding: 0 50px;
    margin: 0 auto;
    font-weight: bolder;
    width: max-content;
    max-width: 700px;
  }
</style>

<script type="text/javascript">
  const searchParams = new URLSearchParams(location.search);
  const chosenCategory = searchParams.get('category');

  const categoryImages = {
    MICROPHONE: "categories_microphone.png",
    BALLET_SHOES: "categories_ballet_shoes.png",
    TRUMPET: "categories_trumpet.png",
    MASK: "categories_mask.png",
    PAINTBRUSH: "categories_paintbrush.png",
  }

  function getImageTag(event) {
    let imageUrl;

    if (event.image && event.image.length > 50) {
      imageUrl = `data:image;base64, ${event.image}`;
    }
    else {
      const imageName = categoryImages[event.image];
      imageUrl = `https://warwick.ac.uk/services/engagementgroup/marketing/digitalengagement/screens/feeds/wsaf/${imageName || 'categories_mask.png'}`;
    }

    return `<img alt="Event image" src="${imageUrl}">`;
  }

  function formatEventTime(event) {
    const startTime = new Date(Date.parse(event.start));
    const endTime = new Date(Date.parse(event.end));

    let startTimeFormatted = new Intl.DateTimeFormat('en-GB', {
      hour: 'numeric',
      minute: startTime.getMinutes() === 0 ? undefined : 'numeric',
      hour12: true,
    }).format(startTime).replaceAll(' ', '');
    const endTimeFormatted = new Intl.DateTimeFormat('en-GB', {
      hour: 'numeric',
      minute: endTime.getMinutes() === 0 ? undefined : 'numeric',
      hour12: true,
    }).format(endTime).replaceAll(' ', '');

    if (startTimeFormatted.includes('PM') && endTimeFormatted.includes('PM')) {
      startTimeFormatted = startTimeFormatted.replace('PM', '');
    }
    else if (startTimeFormatted.includes('AM') && endTimeFormatted.includes('AM')) {
      startTimeFormatted = startTimeFormatted.replace('AM', '');
    }

    const weekday = new Intl.DateTimeFormat('en-GB', {
      weekday: 'short',
    }).format(startTime);

    return `${weekday} ${startTimeFormatted}-${endTimeFormatted}`
  }

  function setHeading(text, colour) {
    const headingDiv = document.getElementsByClassName('wsaf-heading')[0];
    headingDiv.innerHTML = '<p>' + text + '<span class="wsaf-heading-events"> Events</span></p>';
    headingDiv.classList.add(`colour-${colour}`)
    headingDiv.style.display = 'block';
  }

  let filteredEventInstances = [];

  function populate() {
    // Populate events
    // Randomise Feed
    const randomisedEventInstances = filteredEventInstances.map(instance => ({ instance, sort: Math.random() }))
      .sort((a, b) => a.sort - b.sort)
      .map(val => val.instance);

    // Create Articles
    const eventsDiv = document.getElementsByClassName('wsaf-events')[0];
    eventsDiv.innerHTML = '';
    randomisedEventInstances.forEach(eventInstance => {
      const article = document.createElement('article');
      article.classList.add(`colour-${eventInstance.colour}`)
      article.innerHTML = `
        <p class="time">${formatEventTime(eventInstance)}</p>
        ${getImageTag(eventInstance)}
        <div>
            ${eventInstance.organiser ? '<p class="presented-by">' + eventInstance.organiser + ':</p>' : '' }
            <p class="title">${eventInstance.title}</p>
            <p class="venue">${eventInstance.venue}</p>
        </div>
    `;
      eventsDiv.appendChild(article);
    });
  }

  function setup(refreshSeconds = 30) {
    // Parse RSS Feed
    const eventInstances = [];
    const rssFeedElement = document.getElementsByClassName('feed')[0];
    const rssFeedElements = rssFeedElement.getElementsByClassName('feedEntry');
    for (let i = 0; i < rssFeedElements.length; i++) {
      const entry = rssFeedElements[i].getElementsByClassName('entryContent')[0];
      eventInstances.push(JSON.parse(entry.textContent.trim().replaceAll('%20', ' ')));
    }
    rssFeedElement.remove();

    // Filter RSS Feed
    if (chosenCategory) {
      filteredEventInstances = eventInstances.filter(instance => instance.categories.some(category => category.toLowerCase().replaceAll(' ', '-') === chosenCategory));
      if (filteredEventInstances.length === 0) filteredEventInstances = eventInstances;
      else {
        // Set heading. Technically this may be the wrong colour if the first filtered event instance has a non-primary
        // first category, however this is good enough for the moment.
        setHeading(chosenCategory.replaceAll('-', ' '), filteredEventInstances[0].colour);
      }
    }
    else {
      filteredEventInstances = eventInstances;
    }

    // Set to re-populate every minute
    setTimeout(populate, refreshSeconds * 1000);

    // Populate
    populate();

    // Refresh every 10 minutes to re-fetch stale data
    setTimeout(() => location.reload(), 600000);
  }
</script>